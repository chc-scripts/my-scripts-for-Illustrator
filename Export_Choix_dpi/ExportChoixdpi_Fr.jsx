//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/*ExportChoixdpi
>=----------------------------------------------------------------------------------------------------------------------------------------------------------------
Author: Christian Condamine - (christian.condamine@laposte.net)
>=----------------------------------------------------------------------------------------------------------------------------------------------------------------

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
      Exporter chaque calque dans un fichier distinct avec choix de la résolution
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
*/
#targetengine main
var fileName = '';
monFichier = app.activeDocument;
chemin = monFichier.path;
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//    Boîte de dialogue    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
var boiteDial = new Window("dialog","Choisir format et r\351solution"); 
    boiteDial.orientation = "column"; 
    boiteDial.alignChildren = ["left","top"]; 
////  Groupe Format
var grpFormat = boiteDial.add("group", undefined); 
    grpFormat.orientation = "row"; 
    grpFormat.alignChildren = ["left","center"]; 
    grpFormat.spacing = 28
    var sttFormat = grpFormat.add("statictext", undefined, "Format"); 
    var ddl_Format = grpFormat.add("dropdownlist", undefined, [".png",".jpg"]);
      ddl_Format.selection = 0; 
////  Groupe Résolution
var grpResol = boiteDial.add("group", undefined); 
       grpResol.orientation = "row"; 
       grpResol.alignChildren = ["left","center"]; 
       var sttResol = grpResol.add("statictext", undefined, "R\351solution"); 
       var edtResol = grpResol.add("edittext", undefined, 300);
             edtResol.characters = 4;
////  Groupe boutons
var grBoutons = boiteDial.add("group", undefined); 
      grBoutons.orientation = "row"; 
      grBoutons.alignChildren = ["left","center"]; 
      grBoutons.spacing = 10; 
      grBoutons.margins = 0; 
      var btnOk = grBoutons.add("button", undefined, "Ok"); 
            btnOk.onClick= function() {maResolution = parseFloat(edtResol.text)
                                                if(ddl_Format.selection.text === ".png"){
                                                    processPNG(monFichier)
                                                }else{
                                                    processJPG(monFichier)
                                                };
                                                boiteDial.close();
                                            };
      var btnAnnuler = grBoutons.add("button", undefined, "Annuler", {name: "cancel"}); 
boiteDial.show();
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//    Lancement process export en png    //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function processPNG(monFichier){
    var nbCalques = monFichier.layers.length;
    var fname = monFichier.name;
    fname = fname.substr(0,fname.lastIndexOf("."));
    fileName = "" == monFichier.name ? fname : "";
    while (nbCalques--){
        var calqueEnCours = monFichier.layers[nbCalques];
 // Si le calque n'est pas verrouillé
        if(calqueEnCours.locked == false){
            unhideAllUnlocked();
            calqueEnCours.visible=true;
            app.redraw();
            var suffix =  true ? calqueEnCours.name:nbCalques;
                    exportPNG(suffix);
         };
     };
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//    Exporter au format PNG    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function exportPNG(num){
    var exportOptions = new ImageCaptureOptions();  
    var exportName = (chemin+"/"+ fileName+""+num+".png");
    var dest = new File(exportName);
    var type =ExportType.PNG24;
    monFichier.layers[num].hasSelectedArtwork = true;
    app.executeMenuCommand('group');
    var limites = monFichier.selection[0].visibleBounds
     exportOptions.antiAliasing = true;
     exportOptions.artBoardClipping=false;
     exportOptions.transparency=true ;
     exportOptions.horizontalScale = 100;
     exportOptions.verticalScale = 100;
     exportOptions.resolution = maResolution;
    monFichier.imageCapture(dest,limites,exportOptions);
    app.executeMenuCommand('ungroup');
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//    Lancement process export en jpg    ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function processJPG(monFichier){
    monFichier = monFichier;
    var nbCalques = monFichier.layers.length;
    var fname = monFichier.name;
    fname = fname.substr(0,fname.lastIndexOf("."));
    fileName = "" == monFichier.name ? fname : "";
    while (nbCalques--){
        var calqueEnCours = monFichier.layers[nbCalques];
        var monDossier = (chemin);
 // Si le calque n'est pas verrouillé
        if(calqueEnCours.locked == false){
            unhideAllUnlocked();
            calqueEnCours.visible=true;
            app.redraw();
            calqueEnCours.hasSelectedArtwork = true;
            var calqueActif = monFichier.assets.addFromSelection();
            calqueActif.assetName = calqueEnCours.name;
            exportItem(calqueActif, monDossier);
         };
     };
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//    Exporter au format jpg    ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function exportItem (item, monDossier) {
app.preferences.setIntegerPreference('plugin/SmartExportUI/CreateFoldersPreference',0); //désactive la création de sous-dossiers
var whatToExport = new ExportForScreensItemToExport();
whatToExport.assets = [item.assetID]; //Exporter le calque actif
whatToExport.artboards = ' '; // Ne pas exporter le plan de travail
whatToExport.document = false; // Ne pas exporter le document
var jpgOptions = new ExportForScreensOptionsJPEG;
jpgOptions.antiAliasing = AntiAliasingMethod.ARTOPTIMIZED; // Lisser les bords de l'image
jpgOptions.compressionMethod = JPEGCompressionMethodType.BASELINEOPTIMIZED; // Ligne de base standard
jpgOptions.scaleType = ExportForScreensScaleType.SCALEBYRESOLUTION;
jpgOptions.scaleTypeValue = maResolution;
activeDocument.exportForScreens (monDossier, ExportForScreensType.SE_JPEG100, jpgOptions, whatToExport);
};
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//    Rendre tous les calques visibles (sauf les calques verrouillés)    /////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
function unhideAllUnlocked(){
    var all = monFichier.layers.length;
    while(all--){
        if( monFichier.layers[all].locked==false){
        monFichier.layers[all].visible=false;
        };
     };
};